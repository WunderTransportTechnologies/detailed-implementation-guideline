# 重要な制約

## 1. コード配置
- **共通処理は `src/lib/utils/` に配置**
  - 特定のドメインに縛られない汎用的な関数を配置
  - 単一責任の原則に従い、一つの関数は一つの役割のみを持つ
  - 純粋関数（副作用がない関数）を優先
  - 適切なテストを伴うこと

- **UIコンポーネントは `src/components/ui/` に配置**
  - デザインシステムに準拠したコンポーネント
  - プレゼンテーショナルコンポーネントとして実装
  - 内部状態は最小限に抑え、props経由で制御可能に
  - アクセシビリティに配慮した実装

- **Firebase関連の初期化と設定は `src/lib/firebase/` に配置**
  - Firebaseの初期化ロジックは `config.ts` に集約
  - サービスごとに専用のフォルダとファイルを作成
  - 適切なエラーハンドリングとリトライロジックを含める
  - デバッグモードと本番モードの切り替え機能

- **Firestoreデータアクセス関数は `src/lib/firebase/firestore/` に配置**
  - コレクションごとにファイルを分割
  - CRUD操作のラッパー関数を提供
  - クエリビルダーパターンの適用
  - 型安全性の確保

- **Firebase Authentication関連の処理は `src/lib/firebase/auth/` に配置**
  - ユーザー認証フローのラッパー
  - カスタム認証フックの提供
  - セッション管理ロジック
  - 権限管理ヘルパー

- **ユースケースは `src/usecases/` に配置**
  - 特定のビジネスロジックや機能の実装
  - UIとデータアクセスの分離
  - 再利用可能なビジネスロジック
  - 適切な入力バリデーションと例外処理

## 2. 環境変数と認証情報
- **Firebaseの認証情報は `.env` または `.env.local` に保存**
  - 開発環境では `.env.local` を使用
  - 本番環境では `.env` を使用
  - 認証情報は常に環境変数として管理し、コードに直接記述しない
  - CIパイプラインでは環境変数を安全に注入する仕組みを構築

- **環境変数は `NEXT_PUBLIC_FIREBASE_` プレフィックスを使用**
  - クライアントサイドで使用する環境変数には `NEXT_PUBLIC_` プレフィックスを付与
  - 例: `NEXT_PUBLIC_FIREBASE_API_KEY`, `NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN`
  - サーバーサイドのみで使用する環境変数にはプレフィックスなし
  - 例: `FIREBASE_ADMIN_PRIVATE_KEY`, `FIREBASE_ADMIN_CLIENT_EMAIL`

- **秘密鍵やAPIキーはクライアントサイドで直接公開しない**
  - 管理者権限を持つキーや秘密情報はサーバーサイドコードでのみ使用
  - 必要に応じてAPI経由でアクセス
  - 認証情報の漏洩を防ぐための適切な対策を講じる

- **`.env.example` にはダミー値を使用し、必要な環境変数の構造を示す**
  - 全ての必要な環境変数を列挙
  - 各変数の説明とフォーマットを記載
  - 実際の値は含めない
  - 新しい環境変数を追加した場合は必ず例も更新

- **プロダクション環境の認証情報は安全な場所で管理し、CIパイプラインで自動挿入する**
  - シークレット管理サービスの使用を検討
  - GitHub Secretsなどの安全な仕組みを活用
  - 手動での環境変数のセットアップを最小限に抑える
  - 定期的な認証情報のローテーション

## 3. バージョン管理とコミット規約
- **各タスク単位で独立したコミットを作成する**
  - 一つのタスクは一つ以上の論理的に独立したコミットで構成
  - 大きな変更は複数の小さなコミットに分割
  - 各コミットは単一の論理的変更を表す
  - ビルドが壊れる中間状態でのコミットは避ける

- **コミットメッセージは「type(scope): subject」の形式で記述**
  - **type**: 変更の種類を示す
    - `feat`: 新機能
    - `fix`: バグ修正
    - `docs`: ドキュメントのみの変更
    - `style`: コードの意味に影響しない変更（スペース、フォーマット、セミコロンなど）
    - `refactor`: バグ修正や機能追加を行わないコードの変更
    - `test`: テストの追加・修正
    - `chore`: ビルドプロセスやツールの変更、ライブラリの更新など
  - **scope**: 変更の影響範囲（オプション）
    - `auth`: 認証関連
    - `firestore`: Firestoreデータアクセス関連
    - `ui-component`: UIコンポーネント関連
    - `api`: API関連
  - **subject**: 変更内容を簡潔に説明
    - 命令形、現在時制で記述
    - 最初の文字は小文字
    - 末尾にピリオドを付けない

- **タスクID（番号）をコミットメッセージに含める**
  - コミットメッセージの末尾に `(#123)` の形式でタスクIDを記載
  - 例: `feat(auth): implement password reset flow (#45)`
  - イシュー/タスク管理システムとの連携を容易にする

- **一時的なコードやデバッグログを含めない**
  - コメントアウトされた未使用コード
  - `console.log` などのデバッグステートメント
  - TODOコメント（必要な場合はイシューとして管理）
  - テスト用の一時的な設定

- **コミットの前にlintとテストが通過することを確認**
  - ESLintでコードスタイルをチェック
  - 型エラーがないことを確認
  - 関連するテストを実行して通過することを確認
  - Git hooksを使用して自動チェックを設定

- **ビルドが壊れる状態でのコミットを避ける**
  - コミット前にローカルでビルドとテストを実行
  - 複数の開発者が関わる場合は頻繁に最新のコードをプル
  - 緊急の修正が必要な場合は、別ブランチで作業しレビュー後にマージ

## 4. プルリクエストとコードレビュー
- **各実装フェーズは独立したブランチで開発**
  - ブランチ名は `feature/task-id-short-description` の形式
  - 例: `feature/45-password-reset`
  - バグ修正の場合は `fix/task-id-short-description`
  - 例: `fix/67-login-error-handling`

- **フェーズ完了時に詳細な説明を含むプルリクエストを作成**
  - プルリクエストのタイトルは明確で具体的に
  - 変更内容の概要と目的を説明
  - スクリーンショットやデモがあれば添付
  - レビュアーが確認すべき重要ポイントを強調

- **プルリクエストには以下を含める**
  - **実装したタスク一覧とタスクID**
    - 各タスクの簡潔な説明
    - 関連するイシューへのリンク
  - **各タスクの完了基準の達成状況**
    - 明確なチェックリスト形式
    - 未完了の項目がある場合はその理由
  - **テスト結果と品質指標**
    - 実行したテストの種類と結果
    - コードカバレッジ情報
    - パフォーマンス測定結果（該当する場合）
  - **発生した問題と解決策**
    - 実装中に直面した課題
    - 採用した解決策と理由
    - 代替案を検討した場合はその詳細
  - **次のフェーズへの影響**
    - 将来の開発への影響
    - 考慮すべき依存関係
    - 技術的負債の可能性

- **マージ前にコードレビューと自動テストの通過を確認**
  - 最低1名のレビュアーの承認
  - CIパイプラインでのテスト、リント、ビルドの成功
  - プルリクエスト内のすべてのコメントの解決
  - コンフリクトがないことの確認

## 5. ドキュメント更新
- **README.mdは常に最新の状態を維持**
  - プロジェクトの目的と概要
  - 環境構築手順
  - 主要な機能の説明
  - 使用技術のバージョン情報

- **実装計画の更新はREADME.mdに反映**
  - 進行中と今後のタスクを明示
  - 予定の変更があれば理由と共に更新
  - 依存関係や優先順位の変更

- **進捗状況はタスクごとに更新（各タスク完了時）**
  - 完了したタスクはチェックを入れる
  - 完了日を記録
  - 担当者を記録
  - 関連PRへのリンクを追加

- **重要な技術的決定や設計変更もREADME.mdに記録**
  - アーキテクチャの変更
  - 主要なライブラリの選定理由
  - パフォーマンス最適化戦略
  - セキュリティ対策

- **各タスクの完了日、担当者、PRリンクを記録**
  - フォーマット: `[タスク説明] - @担当者 (YYYY-MM-DD, PR #XX)`
  - 例: `認証フローの実装 - @johndoe (2025-01-15, PR #23)`